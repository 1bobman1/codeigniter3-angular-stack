angular.module('GeneralApp', [
    'ngRoute', 'ngMaterial', 'ngAnimate', 'monospaced.elastic', 'angular-clipboard'
])
    .run(['$rootScope', '$location', '$http', '$q',
        '$route', '$routeParams', '$timeout', '$window',
        function ($rootScope, $location, $http, $q,
                  $route, $routeParams, $timeout, $window) {
            $rootScope.mainModule = true;
            $rootScope.user = {};
            $rootScope.testingMode = $routeParams.testingMode;
            var original,
                lastRoute,
                requestId = 0;

            $rootScope.setHomeRoute = function (route) {
                $rootScope.homeRoute = route;
            };

            if ($rootScope.isLoginAuth === true) {
                $rootScope.isLoginAuth = true;
            }

            $rootScope.$on('$routeChangeSuccess', function (event, current) {
                if ($location.path() === '/') {
                    $rootScope.currentNavItem = 'main';
                } else {
                    $rootScope.currentNavItem = '';
                }
            });

            original = $location.path;
            $location.path = function (param, reload) {
                var lastRoute,
                    un,
                    current,
                    currentRequestId;
                if (!param) {
                    return original.call($location);
                }
                currentRequestId = ++requestId;
                if (reload === false) {
                    lastRoute = $route.current;
                    un = $rootScope.$on('$locationChangeSuccess', function () {
                        un();
                        if (requestId !== currentRequestId) {
                            return;
                        }
                        if (!angular.equals($route.current.params, lastRoute.params)) {
                            $rootScope.$broadcast('$routeUpdate');
                        }
                        current = $route.current;
                        $route.current = lastRoute;
                        $timeout(function () {
                            if (requestId !== currentRequestId) {
                                return;
                            }
                            $route.current = current;
                        });
                    });
                    $timeout(un);
                }
                return original.call($location, param);
            };
            $rootScope.isRoute = function (path) {
                current = '';
                try {
                    current = $location.path().toString();
                } catch (ex) {
                }
                return (current == path);
            }
            console.log('Root.scope', $rootScope);
        }
    ])

    .config(['$routeProvider', '$locationProvider', '$mdThemingProvider', '$mdAriaProvider',
        function ($routeProvider, $locationProvider, $mdThemingProvider, $mdAriaProvider) {
            $locationProvider.html5Mode({
                enabled: true,
                requireBase: false
            });

            $mdAriaProvider.disableWarnings();

            $routeProvider
                .when('/', {
                    controller: 'MainCtrl',
                    templateUrl: 'public/html/index.html'
                })
                .when('/help', {
                    controller: 'HelpCtrl',
                    templateUrl: 'public/html/help.html'
                })
                .when('/login', {
                    controller: 'LoginCtrl',
                    templateUrl: 'public/html/login.html'
                })
                .when('/profile', {
                    controller: 'ProfileCtrl',
                    resolve: {
                        'check': function ($location, $rootScope) {
                            if (!$rootScope.isLoginAuth) {
                                $location.url('/login');
                            }
                        }
                    },
                    templateUrl: 'public/html/profile.html'
                })
                .otherwise({
                    redirectTo: '/'
                });
        }
    ]);

angular.module('GeneralApp')
.controller('HelpCtrl', ['$scope', '$rootScope', '$http', '$location', 'DocTitle', '$filter',
    function ($scope, $rootScope, $http, $location, DocTitle, $filter) {
        DocTitle.mainTitle = 'Help';
        DocTitle.Set('page');
    }
]);

angular.module('GeneralApp')
.controller('LoginCtrl', ['$scope', '$rootScope', '$http', '$location', 'DocTitle', '$filter',
    function ($scope, $rootScope, $http, $location, DocTitle, $filter) {
        DocTitle.mainTitle = 'Login';
        DocTitle.Set('Page');

        $rootScope.isLoginAuth = false;
        $scope.errorAuth = false;
        $scope.userAuth = {
            email: '',
            password: ''
        };

        $scope.siginIn = function () {
            console.log('LOGIN');
            var email = $scope.userAuth.email,
                password = $scope.userAuth.password;

            if (email == 'ooo@o.oo' && password == '12345') {
                $rootScope.isLoginAuth = true;
                $rootScope.user = {
                    email: email,
                    userId: '11'
                };
                console.log('auth', $rootScope.user);
                $scope.userAuth.email = '';
                $scope.userAuth.password = '';
                $scope.errorAuth = false;
            } else {
                $scope.errorAuth = true;
            }

            if ($rootScope.isLoginAuth === true) {
                $location.url('/profile');
            }
        };

        // $scope.getData = function () {
        //     $http.post('/home/get_data/').then(function (response) {
        //         console.log(response);
        //         $scope.dataBigTest = response.data.object;
        //     }, function (resp) { });
        // }
        // $scope.getData();
    }
]);

angular.module('GeneralApp')
.controller('MainCtrl', ['$scope', '$rootScope', '$http', '$location', 'DocTitle', '$filter',
    function ($scope, $rootScope, $http, $location, DocTitle, $filter) {
        DocTitle.mainTitle = 'Main';
        DocTitle.Set('App');

        $scope.dataBigTest = {};

        $scope.getData = function () {
            $http.get('/web/api/users/getUsersList').then(function (response) {
                console.log(response);
                $scope.dataBigTest = response.data.object;
            }, function (resp) { });
        }
        $scope.getData();
    }
]);

angular.module('GeneralApp')
.controller('ProfileCtrl', ['$scope', '$rootScope', '$http', '$location', 'DocTitle', '$filter',
    function ($scope, $rootScope, $http, $location, DocTitle, $filter) {
        DocTitle.mainTitle = 'Profile';
        DocTitle.Set('page');

        $scope.siginOut = function () {
            $rootScope.isLoginAuth = false;
            $location.url('/');
        };
    }
]);

angular.module('GeneralApp')
.directive('header', function () {
    return {
        restrict: 'E',
        templateUrl: '/public/html/parts/header.html',
        controller: HeaderCtrl,
        link: function () {
        }
    };

    function HeaderCtrl() {
        console.log('header');
    }
});

angular.module('GeneralApp')
.service('DocTitle', [function () {
        this.init = function () {
            this.mainTitle = document.title;
        };

        this.Set = function (title) {
            document.title = this.mainTitle + ' - ' + title;
        };

        this.SetFull = function (title) {
            document.title = title;
        };

        this.init();
    }]);
