angular.module('GeneralApp', [
    'ngRoute', 'ngMaterial', 'ngAnimate', 'angular-clipboard', 'oc.lazyLoad'
])
    .run(['$rootScope', '$location', '$http', '$q',
        '$route', '$routeParams', '$timeout', '$window',
        function ($rootScope, $location, $http, $q,
                  $route, $routeParams, $timeout, $window) {
            $rootScope.mainModule = true;
            $rootScope.user = {};
            $rootScope.testingMode = $routeParams.testingMode;
            var original,
                lastRoute,
                requestId = 0;

            $rootScope.user = userProfile;

            $rootScope.siginOut = function () {
                $http.get('/web/api/users/siginOut').then(function (response) {
                    if (response.data.status === true) {
                        $window.location.reload();
                    }
                }, function (resp) { });
            };

            $rootScope.$on('$routeChangeSuccess', function (event, current) {
                if ($location.path() === '/') {
                    $rootScope.currentNavItem = 'main';
                } else {
                    $rootScope.currentNavItem = '';
                }
            });

            original = $location.path;
            $location.path = function (param, reload) {
                var lastRoute,
                    un,
                    current,
                    currentRequestId;
                if (!param) {
                    return original.call($location);
                }
                currentRequestId = ++requestId;
                if (reload === false) {
                    lastRoute = $route.current;
                    un = $rootScope.$on('$locationChangeSuccess', function () {
                        un();
                        if (requestId !== currentRequestId) {
                            return;
                        }
                        if (!angular.equals($route.current.params, lastRoute.params)) {
                            $rootScope.$broadcast('$routeUpdate');
                        }
                        current = $route.current;
                        $route.current = lastRoute;
                        $timeout(function () {
                            if (requestId !== currentRequestId) {
                                return;
                            }
                            $route.current = current;
                        });
                    });
                    $timeout(un);
                }
                return original.call($location, param);
            };
            $rootScope.isRoute = function (path) {
                current = '';
                try {
                    current = $location.path().toString();
                } catch (ex) {
                }
                return (current == path);
            }
            console.log('Root.scope', $rootScope);
        }
    ])

    .config(['$routeProvider', '$locationProvider', '$mdThemingProvider', '$mdAriaProvider',
        function ($routeProvider, $locationProvider, $mdThemingProvider, $mdAriaProvider) {
            $locationProvider.html5Mode({
                enabled: true,
                requireBase: false
            });

            $mdAriaProvider.disableWarnings();

            $routeProvider
                .when('/', {
                    controller: 'MainCtrl',
                    templateUrl: 'public/html/index.html'
                })
                .when('/help', {
                    controller: 'HelpCtrl',
                    templateUrl: 'public/html/help.html'
                })
                .when('/login', {
                    controller: 'LoginCtrl',
                    templateUrl: 'public/html/login.html'
                })
                .when('/profile', {
                    controller: 'ProfileCtrl',
                    resolve: {
                        'check': function ($location, $rootScope) {
                            if (!$rootScope.user.logged_in) {
                                $location.url('/login');
                            }
                        }
                    },
                    templateUrl: 'public/html/profile.html'
                })
                .otherwise({
                    redirectTo: '/'
                });
        }
    ]);

angular.module('GeneralApp')
.controller('HelpCtrl', ['$scope', '$rootScope', '$http', '$location', 'DocTitle', '$filter',
    function ($scope, $rootScope, $http, $location, DocTitle, $filter) {
        DocTitle.mainTitle = 'Help';
        DocTitle.Set('page');
    }
]);

angular.module('GeneralApp')
.controller('LoginCtrl', ['$scope', '$rootScope', '$http', '$location', 'DocTitle', '$filter', '$window',
    function ($scope, $rootScope, $http, $location, DocTitle, $filter, $window) {
        DocTitle.mainTitle = 'Login';
        DocTitle.Set('Page');

        $scope.errorAuth = false;
        $scope.userAuth = {
            email: '',
            password: ''
        };

        if (!$rootScope.user.logged_in) {
            $location.url('/login');
        } else {
            $location.url('/profile');
        }

        $scope.siginIn = function () {
            var email = $scope.userAuth.email,
                password = $scope.userAuth.password;

            if (email != '' && password != '') {

                $http.post('/web/api/users/siginIn', {
                    user: $scope.userAuth
                }).then(function (response) {
                    if (response.data.status === true) {
                        $window.location.reload();
                    }
                }, function (resp) { });

                $scope.errorAuth = false;
            } else {
                $scope.errorAuth = true;
            }
        };
    }
]);

angular.module('GeneralApp')
.controller('MainCtrl', ['$scope', '$rootScope', '$http', '$location', 'DocTitle', '$filter',
    function ($scope, $rootScope, $http, $location, DocTitle, $filter) {
        DocTitle.mainTitle = 'Main';
        DocTitle.Set('App');

        $scope.dataBigTest = {};

        $scope.getData = function () {
            $http.get('/web/api/users/getUsersList').then(function (response) {
                console.log(response);
                $scope.dataBigTest = response.data.object;
            }, function (resp) { });
        }
        $scope.getData();
    }
]);

angular.module('GeneralApp')
.controller('ProfileCtrl', ['$scope', '$rootScope', '$http', '$location', 'DocTitle', '$filter', '$window',
    function ($scope, $rootScope, $http, $location, DocTitle, $filter, $window) {
        DocTitle.mainTitle = 'Profile';
        DocTitle.Set('page');

        $scope.dataRowCorrect = true;
        $scope.data = {};
        $scope.dataList = {};
        $scope.dataDescr = {};
        $scope.dataRow = {};
        $scope.countRow = 0;

        $scope.orderAdd = function () {
            $http.post('/web/api/order/add', {
                dataList: $scope.data,
                dataDescr: $scope.dataDescr
            }).then(function (response) {
                if (response.data.status === true) {
                    $window.location.reload();
                    console.log('added', $scope.data);
                }
            });
        }

        $scope.add = function ($event) {
            if (!$scope.dataRow.productName && !$scope.dataRow.productCount && !$scope.dataRow.price) {
                $scope.dataRowCorrect = false;
            }
            var keyCode = $event.which || $event.keyCode;
            if ($event != null && keyCode === 13) {
                console.log('key', $event.keyCode);
                addTemplatePart();
            }
        };

        $scope.deleteRow = function (key) {
            delete $scope.data[key];
        };

        $scope.addClick = function () {
            console.log('key add');
            addTemplatePart();
        };

        $scope.listData = function () {
        };

        $scope.dataArray = Object.keys($scope.data).map(function (key) {
            return $scope.data[key];
        });

        function addTemplatePart() {
            var element = $window.document.getElementById('productName');
            if ($scope.dataRow.productName != '' && $scope.dataRow.productCount != '' && $scope.dataRow.price != '') {
                $scope.countRow = $scope.countRow + 1;
                [].push.apply($scope.dataList, $scope.data[$scope.countRow] = {
                    idx: $scope.countRow,
                    name: $scope.dataRow.productName,
                    count: $scope.dataRow.productCount,
                    price: $scope.dataRow.price
                });
                $scope.dataRow = {
                    productName: '',
                    productCount: '',
                    price: ''
                }
            }
            if (element) {
                element.focus();
            }
        }
    }
]);

angular.module('GeneralApp')
.directive('footerR', function () {
    return {
        restrict: 'E',
        templateUrl: '/public/html/parts/footer.html',
        controller: FooterCtrl,
        link: function () {
        }
    };

    function FooterCtrl() {
    }
});

angular.module('GeneralApp')
.directive('header', function () {
    return {
        restrict: 'E',
        templateUrl: '/public/html/parts/header.html',
        controller: HeaderCtrl,
        link: function () {
        }
    };

    function HeaderCtrl() {
    }
});

angular.module('GeneralApp')
.directive('orderrow', function ($compile) {
    return {
        restrict: 'E',
        templateUrl: '/public/html/parts/order-row.html',
        link: function (scope, elm) {
            scope.add = function ($event, add = false) {
                var keyCode = $event.which || $event.keyCode;
                if ($event != null && keyCode === 13) {
                    console.log('key', $event.keyCode);
                    addTemplatePart(scope, elm);
                } else if (add === true) {
                    console.log('key add');
                    addTemplatePart(scope, elm);
                }
            };

            function addTemplatePart(scope, elm) {
                scope.countRow = scope.countRow + 1;
                scope.data.price = 111;
                console.log('count row', scope.countRow);
                return elm.after($compile('<orderrow></orderrow>')(scope));
            }
        }
    };
});

angular.module('GeneralApp')
.service('DocTitle', [function () {
        this.init = function () {
            this.mainTitle = document.title;
        };

        this.Set = function (title) {
            document.title = this.mainTitle + ' - ' + title;
        };

        this.SetFull = function (title) {
            document.title = title;
        };

        this.init();
    }]);
